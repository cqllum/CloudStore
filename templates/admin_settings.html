{% extends "base.html" %}

{% block page_title %}System Settings{% endblock %}

{% block content %}
<div class="mb-4">
    <h4 class="mb-2">System Settings</h4>
    <p class="text-muted">Configure system-wide settings and customize your platform appearance</p>
</div>

<form id="settingsForm">
    <div class="row g-4">
        <!-- System Settings -->
        <div class="col-lg-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-light border-0 py-3">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-cogs text-primary me-2"></i>
                        <h6 class="mb-0 fw-semibold">System Configuration</h6>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <label class="form-label fw-medium">Default Replica Count</label>
                        <input type="number" class="form-control" id="replicaCount" min="1" max="10" required>
                        <small class="text-muted">Number of file copies to create</small>
                    </div>
                    <div class="mb-0">
                        <label class="form-label fw-medium">Broker Refresh Interval</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="brokerRefreshInterval" min="1" max="60" required>
                            <span class="input-group-text">min</span>
                        </div>
                        <small class="text-muted">How often to check broker status</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Branding Settings -->
        <div class="col-lg-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-light border-0 py-3">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-palette text-primary me-2"></i>
                        <h6 class="mb-0 fw-semibold">Branding & Theme</h6>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-medium">Site Name</label>
                        <input type="text" class="form-control" id="siteName" placeholder="CloudStore">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-medium">Site Description</label>
                        <input type="text" class="form-control" id="siteDescription" placeholder="Decentralized File Storage System">
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label fw-medium">Primary Color</label>
                            <input type="color" class="form-control form-control-color" id="primaryColor" value="#2563eb">
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-medium">Background</label>
                            <input type="color" class="form-control form-control-color" id="backgroundColor" value="#f8fafc">
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-medium">Sidebar BG</label>
                            <input type="color" class="form-control form-control-color" id="sidebarBg" value="#1e293b">
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-medium">Sidebar Text</label>
                            <input type="color" class="form-control form-control-color" id="sidebarText" value="#cbd5e1">
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-medium">Card BG</label>
                            <input type="color" class="form-control form-control-color" id="cardBg" value="#ffffff">
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-medium">Card Text</label>
                            <input type="color" class="form-control form-control-color" id="cardText" value="#1f2937">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="resetThemeBtn">
                            <i class="fas fa-undo me-1"></i>Reset Theme
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom CSS -->
        <div class="col-lg-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-light border-0 py-3">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-code text-primary me-2"></i>
                        <h6 class="mb-0 fw-semibold">Custom Styling</h6>
                    </div>
                </div>
                <div class="card-body d-flex flex-column">
                    <label class="form-label fw-medium">Additional CSS</label>
                    <textarea class="form-control flex-grow-1" id="customCss" rows="8" placeholder="/* Add your custom CSS here */" style="font-family: 'Courier New', monospace; font-size: 13px;"></textarea>
                    <small class="text-muted mt-2">Override default styles with custom CSS</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary btn-lg px-4">
                    <i class="fas fa-save me-2"></i>Save All Settings
                </button>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block scripts %}
<style>
.form-control-color {
    width: 50px;
    height: 38px;
    border-radius: 6px;
}
.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}
.input-group-text {
    background-color: #f8f9fa;
    border-color: #dee2e6;
    color: #6c757d;
    font-size: 0.875rem;
}
</style>
<script>
function loadSettings() {
    fetch('/admin/settings')
        .then(response => response.json())
        .then(data => {
            document.getElementById('replicaCount').value = data.replica_count;
            document.getElementById('brokerRefreshInterval').value = data.broker_refresh_interval;
            document.getElementById('siteName').value = data.site_name || 'CloudStore';
            document.getElementById('siteDescription').value = data.site_description || 'Decentralized File Storage System';
            document.getElementById('primaryColor').value = data.primary_color || '#2563eb';
            document.getElementById('backgroundColor').value = data.background_color || '#f8fafc';
            document.getElementById('sidebarBg').value = data.sidebar_bg || '#1e293b';
            document.getElementById('sidebarText').value = data.sidebar_text || '#cbd5e1';
            document.getElementById('cardBg').value = data.card_bg || '#ffffff';
            document.getElementById('cardText').value = data.card_text || '#1f2937';
            document.getElementById('customCss').value = data.custom_css || '';
        })
        .catch(error => {
            console.error('Error loading settings:', error);
        });
}

document.getElementById('settingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const replicaCount = parseInt(document.getElementById('replicaCount').value);
    const brokerRefreshInterval = parseInt(document.getElementById('brokerRefreshInterval').value);
    const siteName = document.getElementById('siteName').value;
    const siteDescription = document.getElementById('siteDescription').value;
    const primaryColor = document.getElementById('primaryColor').value;
    const backgroundColor = document.getElementById('backgroundColor').value;
    const sidebarBg = document.getElementById('sidebarBg').value;
    const sidebarText = document.getElementById('sidebarText').value;
    const cardBg = document.getElementById('cardBg').value;
    const cardText = document.getElementById('cardText').value;
    const customCss = document.getElementById('customCss').value;
    
    fetch('/admin/settings', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            replica_count: replicaCount,
            broker_refresh_interval: brokerRefreshInterval,
            site_name: siteName,
            site_description: siteDescription,
            primary_color: primaryColor,
            background_color: backgroundColor,
            sidebar_bg: sidebarBg,
            sidebar_text: sidebarText,
            card_bg: cardBg,
            card_text: cardText,
            custom_css: customCss
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            // Show success message with better styling
            const btn = document.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check me-2"></i>Saved Successfully!';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
            }, 2000);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error saving settings: ' + error.message);
    });
});

loadSettings();

// Live preview for color changes
document.getElementById('primaryColor').addEventListener('input', function(e) {
    document.documentElement.style.setProperty('--primary-color', e.target.value);
});
document.getElementById('backgroundColor').addEventListener('input', function(e) {
    document.documentElement.style.setProperty('--content-bg', e.target.value);
});
document.getElementById('sidebarBg').addEventListener('input', function(e) {
    document.documentElement.style.setProperty('--sidebar-bg', e.target.value);
});
document.getElementById('sidebarText').addEventListener('input', function(e) {
    document.documentElement.style.setProperty('--sidebar-text', e.target.value);
});
document.getElementById('cardBg').addEventListener('input', function(e) {
    document.documentElement.style.setProperty('--card-bg', e.target.value);
});
document.getElementById('cardText').addEventListener('input', function(e) {
    document.documentElement.style.setProperty('--card-text', e.target.value);
});

// Reset theme functionality
document.getElementById('resetThemeBtn').addEventListener('click', function() {
    if (confirm('Reset all theme settings to defaults? This cannot be undone.')) {
        fetch('/admin/reset_theme', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Theme reset successfully! Refreshing page...');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error resetting theme: ' + error.message);
        });
    }
});
</script>
{% endblock %}