{% extends "base.html" %}

{% block page_title %}My Files{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <p class="text-muted mb-0">Manage your distributed file storage</p>
    </div>
    <div>
        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#uploadModal">
            <i class="fas fa-upload me-1"></i>Upload
        </button>
        <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#createModal">
            <i class="fas fa-file-plus me-1"></i>New File
        </button>
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#folderModal">
            <i class="fas fa-folder-plus me-1"></i>New Folder
        </button>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
            <div class="input-group" style="width: 350px;">
                <input type="text" class="form-control" id="searchInput" placeholder="Search files...">
                <button class="btn btn-outline-secondary" onclick="searchFiles()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-secondary active" id="gridBtn" onclick="setView('grid')">
                    <i class="fas fa-th me-1"></i>Grid
                </button>
                <button class="btn btn-outline-secondary" id="listBtn" onclick="setView('list')">
                    <i class="fas fa-list me-1"></i>List
                </button>
                <button class="btn btn-outline-secondary" id="detailBtn" onclick="setView('detail')">
                    <i class="fas fa-table me-1"></i>Details
                </button>
            </div>
        </div>
    </div>
</div>

<nav aria-label="breadcrumb" id="breadcrumb" style="display:none;">
    <ol class="breadcrumb bg-light p-3 rounded" id="breadcrumbList"></ol>
</nav>

<div id="filesList" class="mt-3">Loading...</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toast" class="toast" role="alert">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">CloudStore</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

<!-- Upload Queue -->
<div id="uploadQueue" class="position-fixed bottom-0 end-0 m-3" style="width: 350px; z-index: 1050; display: none;">
    <div class="card shadow">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
            <small class="fw-bold">Uploads</small>
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleUploadQueue()">
                <i class="fas fa-minus" id="queueToggleIcon"></i>
            </button>
        </div>
        <div class="card-body p-2" id="uploadQueueBody" style="max-height: 300px; overflow-y: auto;">
            <!-- Upload items will be added here -->
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Upload File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select File</label>
                        <input type="file" class="form-control" name="file" required>
                    </div>
                    <input type="hidden" name="virtual_path" id="uploadPath" value="/">
                    <div class="progress mt-3" id="uploadProgress" style="display:none;">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="uploadStatus" class="mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" id="uploadBtn">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create File Modal -->
<div class="modal fade" id="createModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Create File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createForm">
                <div class="modal-body">
                    <input type="text" class="form-control mb-2" name="filename" placeholder="File name" required>
                    <textarea class="form-control" name="content" rows="5" placeholder="Content"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- File Metadata Modal -->
<div class="modal fade" id="metadataModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>File Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="metadataContent"></div>
        </div>
    </div>
</div>

<!-- Create Folder Modal -->
<div class="modal fade" id="folderModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Create Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="folderForm">
                <div class="modal-body">
                    <input type="text" class="form-control" name="foldername" placeholder="Folder name" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-info">Create Folder</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- File Operations Modal -->
<div class="modal fade" id="opsModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>File Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="opsContent"></div>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div id="contextMenu" class="dropdown-menu" style="display: none; position: absolute; z-index: 1000;">
    <div id="contextMenuContent"></div>
</div>


{% endblock %}

{% block scripts %}
<script>
let currentView = 'grid';
let currentPath = '/';
let brokerStatus = {};

function loadFiles(path) {
    if (!path) path = '/';
    currentPath = path;
    
    // Update upload form path
    document.getElementById('uploadPath').value = currentPath;
    
    fetch('/files?path=' + encodeURIComponent(path))
        .then(response => response.json())
        .then(data => {
            updateBreadcrumb(path);
            
            if (Object.keys(data).length === 0) {
                console.log('No files found, showing empty message');
                let emptyHtml = '';
                if (currentPath !== '/') {
                    emptyHtml = currentView === 'grid' ? renderGridView({}) : renderListView({});
                    emptyHtml += '<div class="text-center p-5"><i class="fas fa-folder-open fa-4x text-muted mb-3"></i><h5>This folder is empty</h5><p class="text-muted">Upload files or create folders</p></div>';
                } else {
                    emptyHtml = '<div class="text-center p-5"><i class="fas fa-folder-open fa-4x text-muted mb-3"></i><h5>This folder is empty</h5><p class="text-muted">Upload files or create folders</p></div>';
                }
                document.getElementById('filesList').innerHTML = emptyHtml;
            } else {
                console.log('Rendering files with view:', currentView);
                let html;
                if (currentView === 'grid') html = renderGridView(data);
                else if (currentView === 'detail') html = renderDetailView(data);
                else html = renderListView(data);
                console.log('Generated HTML length:', html.length);
                document.getElementById('filesList').innerHTML = html;
            }
        })
        .catch(error => {
            document.getElementById('filesList').innerHTML = '<div class="alert alert-danger">Error loading files</div>';
        });
}

function updateBreadcrumb(path) {
    const breadcrumb = document.getElementById('breadcrumb');
    const breadcrumbList = document.getElementById('breadcrumbList');
    
    if (path === '/') {
        breadcrumb.style.display = 'none';
        return;
    }
    
    breadcrumb.style.display = 'block';
    let html = '<li class="breadcrumb-item"><a href="#" onclick="navigateToPath(\'/\')" style="cursor:pointer;">Home</a></li>';
    
    const parts = path.split('/').filter(p => p);
    let buildPath = '';
    
    parts.forEach((part, index) => {
        buildPath += '/' + part;
        if (index === parts.length - 1) {
            html += '<li class="breadcrumb-item active">' + part + '</li>';
        } else {
            html += '<li class="breadcrumb-item"><a href="#" onclick="navigateToPath(\'' + buildPath + '/\')" style="cursor:pointer;">' + part + '</a></li>';
        }
    });
    
    breadcrumbList.innerHTML = html;
}

function navigateToPath(path) {
    loadFiles(path);
}

function getFolderFileCount(folderName) {
    try {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', '/folder_count?path=' + encodeURIComponent(currentPath + folderName + '/'), false);
        xhr.send();
        if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            return data.count || 0;
        }
    } catch (e) {
        console.error('Error getting folder count:', e);
    }
    return 0;
}

function renderGridView(data) {
    let html = '<div class="row">';
    
    if (currentPath !== '/') {
        html += '<div class="col-md-2 mb-3">' +
                '<div class="card folder-card h-100" onclick="goBack()" ondrop="dropToParent(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">'+
                '<div class="card-body text-center">' +
                '<i class="fas fa-arrow-left fa-3x text-secondary mb-2"></i>' +
                '<h6 class="card-title">.. Back</h6>' +
                '<small class="text-muted">Parent folder</small>' +
                '</div></div></div>';
    }
    
    for (let [name, item] of Object.entries(data)) {
        if (item.type === 'file') {
            const isOffline = item.broker_id && brokerStatus[item.broker_id] === false;
            const cardClass = isOffline ? 'card file-card h-100 opacity-50' : 'card file-card h-100';
            const iconClass = isOffline ? 'fas fa-file fa-3x text-danger mb-2' : 'fas fa-file fa-3x text-muted mb-2';
            const downloadBtn = isOffline ? 
                '<button class="btn btn-sm btn-outline-secondary me-1" disabled title="Broker Offline"><i class="fas fa-download"></i></button>' :
                '<button class="btn btn-sm btn-outline-success me-1" onclick="downloadFile(\'' + name + '\')" title="Download"><i class="fas fa-download"></i></button>';
            
            html += '<div class="col-md-2 mb-3">' +
                    '<div class="' + cardClass + '" draggable="true" ondragstart="dragStart(event, \'' + name + '\', \'file\')" oncontextmenu="showFileContextMenu(event, \'' + name + '\')">' +
                    '<div class="card-body text-center">' +
                    '<i class="' + iconClass + '"></i>' +
                    '<h6 class="card-title">' + name + '</h6>' +
                    '<small class="text-muted">' + formatBytes(item.size) + '</small>' +
                    (isOffline ? '<div><small class="text-danger">Broker Offline</small></div>' : '') +
                    '<div class="mt-2">' +
                    downloadBtn +
                    '<button class="btn btn-sm btn-outline-primary me-1" onclick="showMetadata(\'' + name + '\')" title="Info"><i class="fas fa-info"></i></button>' +
                    '<button class="btn btn-sm btn-outline-secondary" onclick="showOps(\'' + name + '\')" title="Options"><i class="fas fa-cog"></i></button>' +
                    '</div></div></div></div>'
        } else {
            const fileCount = getFolderFileCount(name);
            html += '<div class="col-md-2 mb-3">' +
                    '<div class="card folder-card h-100" draggable="true" ondragstart="dragStart(event, \'' + name + '\', \'folder\')" onclick="openFolder(\'' + name + '\')" oncontextmenu="showFolderContextMenu(event, \'' + name + '\')" ondrop="drop(event, \'' + name + '\')" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">'+
                    '<div class="card-body text-center">' +
                    '<i class="fas fa-folder fa-3x text-warning mb-2"></i>' +
                    '<h6 class="card-title">' + name + '</h6>' +
                    '<small class="text-muted">' + fileCount + ' items</small>' +
                    '</div></div></div>'
        }
    }
    html += '</div>';
    return html;
}

function renderListView(data) {
    let html = '<div class="list-group">';
    
    if (currentPath !== '/') {
        html += '<div class="list-group-item d-flex justify-content-between align-items-center folder-item" onclick="goBack()" ondrop="dropToParent(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">' +
                '<div class="d-flex align-items-center">' +
                '<i class="fas fa-arrow-left text-secondary me-3"></i>' +
                '<h6 class="mb-0">.. Back</h6>' +
                '</div>' +
                '<small class="text-muted">Parent folder</small>' +
                '</div>';
    }
    
    for (let [name, item] of Object.entries(data)) {
        if (item.type === 'file') {
            const isOffline = item.broker_id && brokerStatus[item.broker_id] === false;
            const itemClass = isOffline ? 'list-group-item d-flex justify-content-between align-items-center opacity-50' : 'list-group-item d-flex justify-content-between align-items-center';
            const iconClass = isOffline ? 'fas fa-file text-danger me-3' : 'fas fa-file text-muted me-3';
            const downloadBtn = isOffline ? 
                '<button class="btn btn-sm btn-outline-secondary me-1" disabled title="Broker Offline"><i class="fas fa-download"></i></button>' :
                '<button class="btn btn-sm btn-outline-success me-1" onclick="downloadFile(\'' + name + '\')" title="Download"><i class="fas fa-download"></i></button>';
            
            html += '<div class="' + itemClass + '" draggable="true" ondragstart="dragStart(event, \'' + name + '\', \'file\')" oncontextmenu="showFileContextMenu(event, \'' + name + '\')">' +
                    '<div class="d-flex align-items-center">' +
                    '<i class="' + iconClass + '"></i>' +
                    '<div>' +
                    '<h6 class="mb-0">' + name + '</h6>' +
                    '<small class="text-muted">' + formatBytes(item.size) + (isOffline ? ' - Broker Offline' : '') + '</small>' +
                    '</div></div>' +
                    '<div>' +
                    downloadBtn +
                    '<button class="btn btn-sm btn-outline-primary me-1" onclick="showMetadata(\'' + name + '\')" title="Info"><i class="fas fa-info"></i></button>' +
                    '<button class="btn btn-sm btn-outline-secondary" onclick="showOps(\'' + name + '\')" title="Options"><i class="fas fa-cog"></i></button>' +
                    '</div></div>';
        } else {
            const fileCount = getFolderFileCount(name);
            html += '<div class="list-group-item d-flex justify-content-between align-items-center folder-item" onclick="openFolder(\'' + name + '\')" oncontextmenu="showFolderContextMenu(event, \'' + name + '\')" ondrop="drop(event, \'' + name + '\')" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">' +
                    '<div class="d-flex align-items-center">' +
                    '<i class="fas fa-folder text-warning me-3"></i>' +
                    '<h6 class="mb-0">' + name + '</h6>' +
                    '</div>' +
                    '<small class="text-muted">' + fileCount + ' items</small>' +
                    '</div>';
        }
    }
    html += '</div>';
    return html;
}

function renderDetailView(data) {
    let html = '<table class="table table-hover detail-table">' +
               '<thead><tr>' +
               '<th onclick="sortBy(\'name\')" title="Sort by name">Name <i class="fas fa-sort"></i></th>' +
               '<th onclick="sortBy(\'type\')" title="Sort by type">Type</th>' +
               '<th onclick="sortBy(\'size\')" title="Sort by size">Size <i class="fas fa-sort"></i></th>' +
               '<th onclick="sortBy(\'date\')" title="Sort by date">Modified <i class="fas fa-sort"></i></th>' +
               '<th>Actions</th>' +
               '</tr></thead><tbody>';
    
    if (currentPath !== '/') {
        html += '<tr onclick="goBack()" style="cursor:pointer;">' +
                '<td><i class="fas fa-arrow-left text-secondary me-2"></i>.. Back</td>' +
                '<td>Folder</td><td>-</td><td>-</td><td>-</td></tr>';
    }
    
    for (let [name, item] of Object.entries(data)) {
        if (item.type === 'file') {
            const isOffline = item.broker_id && brokerStatus[item.broker_id] === false;
            const rowClass = isOffline ? 'opacity-50' : '';
            html += '<tr class="' + rowClass + '" draggable="true" ondragstart="dragStart(event, \'' + name + '\', \'file\')">' +
                    '<td><i class="fas fa-file text-muted me-2"></i>' + name + (isOffline ? ' <small class="text-danger">(Offline)</small>' : '') + '</td>' +
                    '<td>File</td>' +
                    '<td>' + formatBytes(item.size) + '</td>' +
                    '<td>' + (item.created_at ? new Date(item.created_at).toLocaleDateString() : '-') + '</td>' +
                    '<td>' +
                    '<button class="btn btn-sm btn-outline-success me-1" onclick="downloadFile(\'' + name + '\')" ' + (isOffline ? 'disabled' : '') + '><i class="fas fa-download"></i></button>' +
                    '<button class="btn btn-sm btn-outline-primary me-1" onclick="showMetadata(\'' + name + '\')" title="Info"><i class="fas fa-info"></i></button>' +
                    '<button class="btn btn-sm btn-outline-secondary" onclick="showOps(\'' + name + '\')" title="Options"><i class="fas fa-cog"></i></button>' +
                    '</td></tr>';
        } else {
            const fileCount = getFolderFileCount(name);
            html += '<tr onclick="openFolder(\'' + name + '\')" style="cursor:pointer;" ondrop="drop(event, \'' + name + '\')" ondragover="allowDrop(event)">' +
                    '<td><i class="fas fa-folder text-warning me-2"></i>' + name + '</td>' +
                    '<td>Folder</td>' +
                    '<td>' + fileCount + ' items</td>' +
                    '<td>-</td>' +
                    '<td><button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); showFolderContextMenu(event, \'' + name + '\')" title="Options"><i class="fas fa-cog"></i></button></td>' +
                    '</tr>';
        }
    }
    html += '</tbody></table>';
    return html;
}

let sortOrder = {};
function sortBy(column) {
    sortOrder[column] = sortOrder[column] === 'asc' ? 'desc' : 'asc';
    
    fetch('/files?path=' + encodeURIComponent(currentPath))
        .then(response => response.json())
        .then(data => {
            const entries = Object.entries(data);
            entries.sort((a, b) => {
                let aVal, bVal;
                switch(column) {
                    case 'name': aVal = a[0]; bVal = b[0]; break;
                    case 'type': aVal = a[1].type; bVal = b[1].type; break;
                    case 'size': aVal = a[1].size || 0; bVal = b[1].size || 0; break;
                    case 'date': aVal = new Date(a[1].created_at || 0); bVal = new Date(b[1].created_at || 0); break;
                }
                if (sortOrder[column] === 'asc') return aVal > bVal ? 1 : -1;
                else return aVal < bVal ? 1 : -1;
            });
            
            const sortedData = Object.fromEntries(entries);
            document.getElementById('filesList').innerHTML = renderDetailView(sortedData);
        });
}

function setView(view) {
    currentView = view;
    document.getElementById('gridBtn').classList.toggle('active', view === 'grid');
    document.getElementById('listBtn').classList.toggle('active', view === 'list');
    document.getElementById('detailBtn').classList.toggle('active', view === 'detail');
    loadFiles();
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showMetadata(filename) {
    fetch('/file_metadata?filename=' + encodeURIComponent(filename) + '&path=' + encodeURIComponent(currentPath))
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('Error: ' + data.error, 'error');
                return;
            }
            
            let replicasHtml = '';
            if (data.replicas && data.replicas.length > 0) {
                data.replicas.forEach(replica => {
                    const primaryBadge = replica.is_primary ? '<span class="badge bg-success ms-2">Primary</span>' : '';
                    replicasHtml += '<div class="card mb-2">' +
                                   '<div class="card-body p-3">' +
                                   '<h6 class="card-title mb-1">' + replica.broker_name + primaryBadge + '</h6>' +
                                   '<span class="badge bg-secondary">' + replica.broker_type + '</span>' +
                                   '<p class="mt-2 mb-0"><small class="text-muted">Path: ' + replica.storage_path + '</small></p>' +
                                   '</div></div>';
                });
            } else {
                replicasHtml = '<p class="text-muted">No replica information available</p>';
            }
            
            const content = '<div class="row">' +
                           '<div class="col-md-6">' +
                           '<h6>File Details</h6>' +
                           '<p><strong>Name:</strong> ' + data.filename + '</p>' +
                           '<p><strong>Size:</strong> ' + formatBytes(data.size) + '</p>' +
                           '<p><strong>Path:</strong> ' + data.virtual_path + '</p>' +
                           '<p><strong>Created:</strong> ' + new Date(data.created_at).toLocaleString() + '</p>' +
                           '</div>' +
                           '<div class="col-md-6">' +
                           '<h6>Storage Replicas (' + (data.replicas ? data.replicas.length : 0) + ')</h6>' +
                           replicasHtml +
                           '</div></div>';
            
            document.getElementById('metadataContent').innerHTML = content;
            new bootstrap.Modal(document.getElementById('metadataModal')).show();
        });
}

function showOps(filename) {
    let content = '<div class="d-grid gap-2">' +
                  '<button class="btn btn-outline-success" onclick="downloadFile(\'' + filename + '\')">' +
                  '<i class="fas fa-download me-2"></i>Download</button>' +
                  '<button class="btn btn-outline-primary" onclick="renameFile(\'' + filename + '\')">' +
                  '<i class="fas fa-edit me-2"></i>Rename</button>';
    
    if (currentPath !== '/') {
        content += '<button class="btn btn-outline-warning" onclick="moveToRoot(\'' + filename + '\')">' +
                   '<i class="fas fa-home me-2"></i>Move to Root</button>';
    }
    
    content += '<button class="btn btn-danger" onclick="deleteFile(\'' + filename + '\')">' +
               '<i class="fas fa-trash me-2"></i>Delete</button>' +
               '</div>';
    
    document.getElementById('opsContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('opsModal')).show();
}

function downloadFile(filename) {
    fetch('/download_file?filename=' + encodeURIComponent(filename) + '&path=' + encodeURIComponent(currentPath))
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || 'Download failed');
                });
            }
            return response.blob();
        })
        .then(blob => {
            if (blob.size === 0) {
                throw new Error('File is empty');
            }
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('Download error:', error);
            showToast('Download failed: ' + error.message, 'error');
        });
    
    if (document.getElementById('opsModal')) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('opsModal'));
        if (modal) modal.hide();
    }
}

function renameFile(filename) {
    const newName = prompt('Enter new filename:', filename);
    if (newName && newName !== filename) {
        fetch('/rename_file', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({old_name: filename, new_name: newName, virtual_path: '/'})
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                loadFiles(currentPath);
                bootstrap.Modal.getInstance(document.getElementById('opsModal')).hide();
            } else {
                showToast(data.error, 'error');
            }
        });
    }
}

function deleteFile(filename) {
    if (confirm('Delete ' + filename + '?')) {
        fetch('/delete_file', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({filename: filename, virtual_path: currentPath})
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                loadFiles(currentPath);
                bootstrap.Modal.getInstance(document.getElementById('opsModal')).hide();
            } else {
                alert(data.error);
            }
        });
    }
}

function moveToRoot(filename) {
    if (confirm('Move "' + filename + '" to root folder?')) {
        fetch('/move_file', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                filename: filename,
                old_path: currentPath,
                new_path: '/'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                loadFiles(currentPath);
            } else {
                alert(data.error);
            }
            bootstrap.Modal.getInstance(document.getElementById('opsModal')).hide();
        });
    }
}

function goBack() {
    const parts = currentPath.split('/').filter(p => p);
    parts.pop();
    const parentPath = parts.length > 0 ? '/' + parts.join('/') + '/' : '/';
    loadFiles(parentPath);
}

function dropToParent(event) {
    event.preventDefault();
    const target = event.target.closest('.folder-card, .folder-item, tr');
    if (target) target.style.backgroundColor = '';
    
    if (draggedItem) {
        const parts = currentPath.split('/').filter(p => p);
        parts.pop();
        const parentPath = parts.length > 0 ? '/' + parts.join('/') + '/' : '/';
        
        if (draggedItem.type === 'file') {
            fetch('/move_file', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    filename: draggedItem.name,
                    old_path: currentPath,
                    new_path: parentPath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    loadFiles(currentPath);
                } else {
                    alert(data.error);
                }
            });
        } else if (draggedItem.type === 'folder') {
            fetch('/move_folder', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    folder_name: draggedItem.name,
                    old_path: currentPath,
                    new_path: parentPath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    loadFiles(currentPath);
                } else {
                    alert(data.error);
                }
            });
        }
    }
    draggedItem = null;
}

function searchFiles() {
    const query = document.getElementById('searchInput').value;
    fetch('/search?q=' + encodeURIComponent(query))
        .then(response => response.json())
        .then(files => {
            let html = '<div class="row">';
            files.forEach(file => {
                html += '<div class="col-md-2 mb-3">' +
                       '<div class="card file-card h-100">' +
                       '<div class="card-body text-center">' +
                       '<i class="fas fa-file fa-3x text-muted mb-2"></i>' +
                       '<h6 class="card-title">' + file.filename + '</h6>' +
                       '<small class="text-muted">' + formatBytes(file.size) + '</small>' +
                       '</div></div></div>'
            });
            html += '</div>';
            document.getElementById('filesList').innerHTML = html;
        });
}

function openFolder(folderName) {
    const newPath = currentPath + folderName + '/';
    loadFiles(newPath);
}

document.getElementById('folderForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('/create_folder', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({path: currentPath + formData.get('foldername') + '/'})
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            loadFiles(currentPath);
            bootstrap.Modal.getInstance(document.getElementById('folderModal')).hide();
            this.reset();
        } else {
            alert(data.error);
        }
    });
});

document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    formData.set('virtual_path', currentPath);
    
    const fileName = formData.get('file').name;
    const uploadId = Date.now();
    
    // Add to upload queue
    addToUploadQueue(uploadId, fileName);
    
    // Hide modal immediately
    bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
    
    const xhr = new XMLHttpRequest();
    
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            updateUploadProgress(uploadId, percentComplete, `${formatBytes(e.loaded)} / ${formatBytes(e.total)}`);
        }
    });
    
    xhr.addEventListener('load', function() {
        if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            if (data.message) {
                completeUpload(uploadId, true);
                setTimeout(() => loadFiles(currentPath), 500);
            } else {
                completeUpload(uploadId, false, data.error);
            }
        } else {
            completeUpload(uploadId, false, 'Upload failed');
        }
    });
    
    xhr.addEventListener('error', function() {
        completeUpload(uploadId, false, 'Network error');
    });
    
    xhr.open('POST', '/upload');
    xhr.send(formData);
});

// Reset upload modal when closed
document.getElementById('uploadModal').addEventListener('hidden.bs.modal', function() {
    const form = document.getElementById('uploadForm');
    const progressContainer = document.getElementById('uploadProgress');
    const progressBar = document.querySelector('#uploadProgress .progress-bar');
    const statusDiv = document.getElementById('uploadStatus');
    const uploadBtn = document.getElementById('uploadBtn');
    
    form.reset();
    progressContainer.style.display = 'none';
    progressBar.style.width = '0%';
    progressBar.textContent = '';
    progressBar.className = 'progress-bar';
    statusDiv.textContent = '';
    uploadBtn.disabled = false;
    uploadBtn.textContent = 'Upload';
});

document.getElementById('createForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('/create_file', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            filename: formData.get('filename'),
            virtual_path: currentPath,
            content: formData.get('content')
        })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message || data.error);
        if (data.message) {
            loadFiles(currentPath);
            bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
            this.reset();
        }
    });
});

// Drag and drop functions
let draggedItem = null;

function dragStart(event, name, type) {
    draggedItem = {name: name, type: type};
    event.dataTransfer.effectAllowed = 'move';
}

function allowDrop(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
}

function dragEnter(event) {
    event.preventDefault();
    event.target.closest('.folder-card').style.backgroundColor = '#e3f2fd';
}

function dragLeave(event) {
    event.target.closest('.folder-card').style.backgroundColor = '';
}

function drop(event, folderName) {
    event.preventDefault();
    const target = event.target.closest('.folder-card, .folder-item, tr');
    if (target) target.style.backgroundColor = '';
    
    if (draggedItem && draggedItem.name !== folderName) {
        if (draggedItem.type === 'file') {
            fetch('/move_file', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    filename: draggedItem.name,
                    old_path: currentPath,
                    new_path: currentPath + folderName + '/'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    loadFiles(currentPath);
                } else {
                    alert(data.error);
                }
            });
        } else if (draggedItem.type === 'folder') {
            fetch('/move_folder', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    folder_name: draggedItem.name,
                    old_path: currentPath,
                    new_path: currentPath + folderName + '/'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    loadFiles(currentPath);
                } else {
                    alert(data.error);
                }
            });
        }
    }
    draggedItem = null;
}

function showFileContextMenu(event, filename) {
    event.preventDefault();
    event.stopPropagation();
    
    const menu = document.getElementById('contextMenu');
    const content = document.getElementById('contextMenuContent');
    
    let menuItems = '<a class="dropdown-item" href="#" onclick="downloadFile(\'' + filename + '\'); hideContextMenu();"><i class="fas fa-download me-2"></i>Download</a>' +
                   '<a class="dropdown-item" href="#" onclick="showMetadata(\'' + filename + '\'); hideContextMenu();"><i class="fas fa-info me-2"></i>Info</a>' +
                   '<a class="dropdown-item" href="#" onclick="renameFile(\'' + filename + '\'); hideContextMenu();"><i class="fas fa-edit me-2"></i>Rename</a>';
    
    if (currentPath !== '/') {
        menuItems += '<a class="dropdown-item" href="#" onclick="moveToRoot(\'' + filename + '\'); hideContextMenu();"><i class="fas fa-home me-2"></i>Move to Root</a>';
    }
    
    menuItems += '<div class="dropdown-divider"></div>' +
                '<a class="dropdown-item text-danger" href="#" onclick="deleteFile(\'' + filename + '\'); hideContextMenu();"><i class="fas fa-trash me-2"></i>Delete</a>';
    
    content.innerHTML = menuItems;
    menu.style.display = 'block';
    menu.style.left = event.pageX + 'px';
    menu.style.top = event.pageY + 'px';
}

function showFolderContextMenu(event, folderName) {
    event.preventDefault();
    event.stopPropagation();
    
    const menu = document.getElementById('contextMenu');
    const content = document.getElementById('contextMenuContent');
    
    const menuItems = '<a class="dropdown-item" href="#" onclick="openFolder(\'' + folderName + '\'); hideContextMenu();"><i class="fas fa-folder-open me-2"></i>Open</a>' +
                     '<a class="dropdown-item" href="#" onclick="renameFolder(\'' + folderName + '\'); hideContextMenu();"><i class="fas fa-edit me-2"></i>Rename</a>' +
                     '<div class="dropdown-divider"></div>' +
                     '<a class="dropdown-item text-danger" href="#" onclick="deleteFolderConfirm(\'' + folderName + '\'); hideContextMenu();"><i class="fas fa-trash me-2"></i>Delete</a>';
    
    content.innerHTML = menuItems;
    menu.style.display = 'block';
    menu.style.left = event.pageX + 'px';
    menu.style.top = event.pageY + 'px';
}

function deleteFolderConfirm(folderName) {
    if (confirm('Delete folder "' + folderName + '" and all its contents?')) {
        fetch('/delete_folder', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({path: currentPath + folderName + '/'})
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                loadFiles(currentPath);
            } else {
                alert(data.error);
            }
        });
    }
}

function renameFolder(folderName) {
    const newName = prompt('Enter new folder name:', folderName);
    if (newName && newName !== folderName) {
        fetch('/rename_folder', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                old_path: currentPath + folderName + '/',
                new_path: currentPath + newName + '/'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                loadFiles(currentPath);
            } else {
                alert(data.error);
            }
        });
    }
}

function hideContextMenu() {
    document.getElementById('contextMenu').style.display = 'none';
}

document.addEventListener('click', hideContextMenu);

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const toastTitle = document.getElementById('toastTitle');
    
    toastMessage.textContent = message;
    toast.className = 'toast';
    
    if (type === 'success') {
        toast.classList.add('bg-success', 'text-white');
        toastTitle.textContent = 'Success';
    } else if (type === 'error') {
        toast.classList.add('bg-danger', 'text-white');
        toastTitle.textContent = 'Error';
    } else {
        toast.classList.add('bg-info', 'text-white');
        toastTitle.textContent = 'Info';
    }
    
    new bootstrap.Toast(toast).show();
}



let uploadQueue = [];
let queueVisible = false;

function addToUploadQueue(uploadId, fileName) {
    uploadQueue.push({ id: uploadId, name: fileName, progress: 0, status: 'uploading' });
    renderUploadQueue();
    showUploadQueue();
}

function updateUploadProgress(uploadId, progress, statusText) {
    const upload = uploadQueue.find(u => u.id === uploadId);
    if (upload) {
        upload.progress = progress;
        upload.statusText = statusText;
        renderUploadQueue();
    }
}

function completeUpload(uploadId, success, error = null) {
    const upload = uploadQueue.find(u => u.id === uploadId);
    if (upload) {
        upload.status = success ? 'completed' : 'failed';
        upload.error = error;
        renderUploadQueue();
        
        // Remove completed/failed uploads after 3 seconds
        setTimeout(() => {
            uploadQueue = uploadQueue.filter(u => u.id !== uploadId);
            renderUploadQueue();
            if (uploadQueue.length === 0) {
                hideUploadQueue();
            }
        }, 3000);
    }
}

function renderUploadQueue() {
    const queueBody = document.getElementById('uploadQueueBody');
    if (uploadQueue.length === 0) {
        queueBody.innerHTML = '<small class="text-muted">No uploads</small>';
        return;
    }
    
    let html = '';
    uploadQueue.forEach(upload => {
        const statusIcon = upload.status === 'completed' ? 'fas fa-check text-success' : 
                          upload.status === 'failed' ? 'fas fa-times text-danger' : 
                          'fas fa-upload text-primary';
        
        html += `
            <div class="d-flex align-items-center mb-2 p-2 bg-light rounded">
                <i class="${statusIcon} me-2"></i>
                <div class="flex-grow-1">
                    <div class="small fw-bold text-truncate" style="max-width: 200px;">${upload.name}</div>
                    ${upload.status === 'uploading' ? `
                        <div class="progress mt-1" style="height: 4px;">
                            <div class="progress-bar" style="width: ${upload.progress}%"></div>
                        </div>
                        <div class="small text-muted">${upload.statusText || 'Uploading...'}</div>
                    ` : upload.status === 'completed' ? `
                        <div class="small text-success">Complete</div>
                    ` : `
                        <div class="small text-danger">${upload.error || 'Failed'}</div>
                    `}
                </div>
            </div>
        `;
    });
    
    queueBody.innerHTML = html;
}

function showUploadQueue() {
    document.getElementById('uploadQueue').style.display = 'block';
    queueVisible = true;
}

function hideUploadQueue() {
    document.getElementById('uploadQueue').style.display = 'none';
    queueVisible = false;
}

function toggleUploadQueue() {
    const queueBody = document.getElementById('uploadQueueBody');
    const toggleIcon = document.getElementById('queueToggleIcon');
    
    if (queueBody.style.display === 'none') {
        queueBody.style.display = 'block';
        toggleIcon.className = 'fas fa-minus';
    } else {
        queueBody.style.display = 'none';
        toggleIcon.className = 'fas fa-plus';
    }
}

// Load files immediately - broker status comes from database
loadFiles('/');
</script>

<style>
.file-card, .folder-card {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    height: 120px;
}
.file-card:hover, .folder-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
.folder-item {
    cursor: pointer;
}
.folder-item:hover {
    background-color: #f8f9fa;
}
.list-group-item[draggable="true"] {
    cursor: move;
}
.detail-table th {
    cursor: pointer;
    user-select: none;
}
.detail-table th:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}