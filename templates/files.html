{% extends "base.html" %}

{% block content %}
<div class="d-flex">
    <!-- Sidebar -->
    <div class="bg-light border-end" style="width: 250px; min-height: 100vh;">
        <div class="p-3">
            <h5 class="mb-3">CloudStore</h5>
            <nav class="nav flex-column">
                <a class="nav-link active" href="/dashboard"><i class="fas fa-folder me-2"></i>My Files</a>
                <a class="nav-link" href="/browse"><i class="fas fa-cloud me-2"></i>Storage Browser</a>
                <a class="nav-link" href="/manage"><i class="fas fa-server me-2"></i>Storage Brokers</a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-grow-1">
        <!-- Toolbar -->
        <div class="bg-white border-bottom p-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="fas fa-upload me-1"></i>Upload
                    </button>
                    <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#createFolderModal">
                        <i class="fas fa-folder-plus me-1"></i>New Folder
                    </button>
                    <button class="btn btn-outline-success me-2" data-bs-toggle="modal" data-bs-target="#createFileModal">
                        <i class="fas fa-file-plus me-1"></i>New File
                    </button>
                    <button class="btn btn-outline-secondary" onclick="loadFiles()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
                <div class="input-group" style="width: 300px;">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search files...">
                    <button class="btn btn-outline-secondary" onclick="searchFiles()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- File Grid -->
        <div class="p-4">
            <div id="filesList">
                <div class="d-flex justify-content-center p-5">
                    <div class="spinner-border" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="uploadModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Files</label>
                        <input type="file" class="form-control" name="file" multiple required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Upload to Folder</label>
                        <input type="text" class="form-control" name="virtual_path" value="/" placeholder="/documents/">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="createFolderModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createFolderForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Folder Name</label>
                        <input type="text" class="form-control" name="path" placeholder="New Folder" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="createFileModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createFileForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">File Name</label>
                        <input type="text" class="form-control" name="filename" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Content</label>
                        <textarea class="form-control" name="content" rows="5" placeholder="Enter file content..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Create File</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="fileMetadataModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">File Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="metadataContent"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="fileOpsModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileOpsTitle">File Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="fileOpsContent"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadFiles() {
    navigateToPath(currentPath);
}

let currentPath = '/';

function renderFileGrid(tree, path = '') {
    let html = '';
    
    // Breadcrumb navigation
    if (path) {
        const parts = path.split('/').filter(p => p);
        html += '<nav aria-label="breadcrumb" class="mb-3">';
        html += '<ol class="breadcrumb">';
        html += '<li class="breadcrumb-item"><a href="#" onclick="navigateToPath(\'/'\')" style="cursor:pointer">Home</a></li>';
        let buildPath = '';
        parts.forEach((part, index) => {
            buildPath += '/' + part;
            if (index === parts.length - 1) {
                html += `<li class="breadcrumb-item active">${part}</li>`;
            } else {
                html += `<li class="breadcrumb-item"><a href="#" onclick="navigateToPath('${buildPath}/')" style="cursor:pointer">${part}</a></li>`;
            }
        });
        html += '</ol></nav>';
    }
    
    html += '<div class="row g-3">';
    for (let [name, item] of Object.entries(tree)) {
        if (item.type === 'file') {
            html += `<div class="col-md-3">
                        <div class="card h-100 file-card">
                            <div class="card-body text-center">
                                <i class="fas fa-file fa-3x text-muted mb-2"></i>
                                <h6 class="card-title">${name}</h6>
                                <small class="text-muted">${formatBytes(item.size)}</small>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="showFileMetadata('${name}', '${path}')">
                                        <i class="fas fa-info"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="showFileOps('${name}', '${path}')">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                     </div>`;
        } else {
            html += `<div class="col-md-3">
                        <div class="card h-100 folder-card" onclick="navigateToFolder('${name}', '${path}')">
                            <div class="card-body text-center">
                                <i class="fas fa-folder fa-3x text-warning mb-2"></i>
                                <h6 class="card-title">${name}</h6>
                                <small class="text-muted">Folder</small>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-warning" onclick="event.stopPropagation(); showFolderOps('${name}', '${path}')">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                     </div>`;
        }
    }
    html += '</div>';
    return html;
}

function navigateToFolder(folderName, path) {
    const newPath = path + folderName + '/';
    navigateToPath(newPath);
}

function navigateToPath(path) {
    currentPath = path;
    fetch(`/files?path=${encodeURIComponent(path)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('filesList').innerHTML = '<div class="alert alert-danger">' + data.error + '</div>';
                return;
            }
            
            if (Object.keys(data).length === 0) {
                document.getElementById('filesList').innerHTML = '<div class="text-center p-5"><i class="fas fa-folder-open fa-4x text-muted mb-3"></i><h5>This folder is empty</h5><p class="text-muted">Upload files or create new ones to get started</p></div>';
                return;
            }
            
            document.getElementById('filesList').innerHTML = renderFileGrid(data, path);
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('filesList').innerHTML = '<div class="alert alert-danger">Error loading files</div>';
        });
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showFileOps(filename, path) {
    const content = '<div class="mb-3 text-center"><i class="fas fa-file fa-3x text-muted mb-2"></i><h6>' + filename + '</h6><small class="text-muted">' + path + '</small></div><div class="d-grid gap-2"><button class="btn btn-outline-primary" onclick="renameFile(\'' + filename + '\', \'' + path + '\')" ><i class="fas fa-edit me-2"></i>Rename</button><button class="btn btn-outline-info" onclick="copyFile(\'' + filename + '\', \'' + path + '\')" ><i class="fas fa-copy me-2"></i>Copy</button><button class="btn btn-outline-warning" onclick="moveFile(\'' + filename + '\', \'' + path + '\')" ><i class="fas fa-arrows-alt me-2"></i>Move</button><button class="btn btn-danger" onclick="deleteFile(\'' + filename + '\', \'' + path + '\')" ><i class="fas fa-trash me-2"></i>Delete</button></div>';
    document.getElementById('fileOpsTitle').textContent = 'File Options';
    document.getElementById('fileOpsContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('fileOpsModal')).show();
}

function showFolderOps(foldername, path) {
    const content = '<div class="mb-3 text-center"><i class="fas fa-folder fa-3x text-warning mb-2"></i><h6>' + foldername + '</h6><small class="text-muted">' + path + '</small></div><div class="d-grid gap-2"><button class="btn btn-outline-primary" onclick="renameFolder(\'' + foldername + '\', \'' + path + '\')" ><i class="fas fa-edit me-2"></i>Rename</button><button class="btn btn-danger" onclick="deleteFolder(\'' + foldername + '\', \'' + path + '\')" ><i class="fas fa-trash me-2"></i>Delete</button></div>';
    document.getElementById('fileOpsTitle').textContent = 'Folder Options';
    document.getElementById('fileOpsContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('fileOpsModal')).show();
}

function searchFiles() {
    const query = document.getElementById('searchInput').value;
    fetch(`/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(files => {
            let html = '<div class="row g-3">';
            files.forEach(file => {
                html += `<div class="col-md-3">
                            <div class="card h-100 file-card" onclick="showFileOps('${file.filename}', '${file.virtual_path}')">
                                <div class="card-body text-center">
                                    <i class="fas fa-file fa-3x text-muted mb-2"></i>
                                    <h6 class="card-title">${file.filename}</h6>
                                    <small class="text-muted">${formatBytes(file.size)}</small>
                                </div>
                            </div>
                         </div>`;
            });
            html += '</div>';
            document.getElementById('filesList').innerHTML = html;
        });
}

// File operations
function renameFile(oldName, path) {
    const newName = prompt('Enter new filename:', oldName);
    if (newName && newName !== oldName) {
        fetch('/rename_file', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({old_name: oldName, new_name: newName, virtual_path: path})
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message || data.error);
            loadFiles();
            bootstrap.Modal.getInstance(document.getElementById('fileOpsModal')).hide();
        });
    }
}

function copyFile(filename, path) {
    const newPath = prompt('Enter destination path:', path);
    const newName = prompt('Enter new filename:', filename);
    if (newPath && newName) {
        fetch('/copy_file', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({filename, old_path: path, new_path: newPath, new_filename: newName})
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message || data.error);
            loadFiles();
            bootstrap.Modal.getInstance(document.getElementById('fileOpsModal')).hide();
        });
    }
}

function moveFile(filename, path) {
    const newPath = prompt('Enter new path:', path);
    if (newPath && newPath !== path) {
        fetch('/move_file', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({filename, old_path: path, new_path: newPath})
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message || data.error);
            loadFiles();
            bootstrap.Modal.getInstance(document.getElementById('fileOpsModal')).hide();
        });
    }
}

function deleteFile(filename, path) {
    if (confirm(`Delete ${filename}?`)) {
        fetch('/delete_file', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({filename, virtual_path: path})
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message || data.error);
            loadFiles();
            bootstrap.Modal.getInstance(document.getElementById('fileOpsModal')).hide();
        });
    }
}

function renameFolder(oldName, path) {
    const newName = prompt('Enter new folder name:', oldName);
    if (newName && newName !== oldName) {
        const oldPath = path + oldName;
        const newPath = path + newName;
        fetch('/rename_folder', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({old_path: oldPath, new_path: newPath})
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message || data.error);
            loadFiles();
            bootstrap.Modal.getInstance(document.getElementById('fileOpsModal')).hide();
        });
    }
}

function deleteFolder(foldername, path) {
    if (confirm(`Delete folder ${foldername} and all contents?`)) {
        fetch('/delete_folder', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({path: path + foldername})
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message || data.error);
            loadFiles();
            bootstrap.Modal.getInstance(document.getElementById('fileOpsModal')).hide();
        });
    }
}

// Form handlers
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    formData.set('virtual_path', currentPath);
    
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message || data.error);
        if (data.message) {
            loadFiles();
            bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
            this.reset();
        }
    });
});

function showFileMetadata(filename, path) {
    fetch(`/file_metadata?filename=${encodeURIComponent(filename)}&path=${encodeURIComponent(path)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            const content = '<div class="row"><div class="col-md-6"><h6>File Details</h6><p><strong>Name:</strong> ' + data.filename + '</p><p><strong>Size:</strong> ' + formatBytes(data.size) + '</p><p><strong>Path:</strong> ' + data.virtual_path + '</p><p><strong>Created:</strong> ' + new Date(data.created_at).toLocaleString() + '</p></div><div class="col-md-6"><h6>Storage Location</h6><div class="card"><div class="card-body"><h6 class="card-title">' + data.broker_name + '</h6><span class="badge bg-secondary">' + data.broker_type + '</span><p class="mt-2 mb-0"><small class="text-muted">Storage Path: ' + data.storage_path + '</small></p></div></div></div></div>';
            
            document.getElementById('metadataContent').innerHTML = content;
            new bootstrap.Modal(document.getElementById('fileMetadataModal')).show();
        });
}

document.getElementById('createFileForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('/create_file', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            filename: formData.get('filename'),
            virtual_path: currentPath,
            content: formData.get('content')
        })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message || data.error);
        if (data.message) {
            loadFiles();
            bootstrap.Modal.getInstance(document.getElementById('createFileModal')).hide();
            this.reset();
        }
    });
});

document.getElementById('createFolderForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('/create_folder', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({path: currentPath + formData.get('path') + '/'})
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message || data.error);
        if (data.message) {
            loadFiles();
            bootstrap.Modal.getInstance(document.getElementById('createFolderModal')).hide();
            this.reset();
        }
    });
});

// Simple initial load
fetch('/files')
    .then(response => response.json())
    .then(data => {
        console.log('Files data:', data);
        if (Object.keys(data).length === 0) {
            document.getElementById('filesList').innerHTML = '<div class="text-center p-5"><i class="fas fa-folder-open fa-4x text-muted mb-3"></i><h5>No files yet</h5><p class="text-muted">Upload files or create new ones to get started</p></div>';
        } else {
            document.getElementById('filesList').innerHTML = renderFileGrid(data, '/');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('filesList').innerHTML = '<div class="alert alert-danger">Error loading files</div>';
    });
</script>

<style>
.file-card, .folder-card {
    cursor: pointer;
    transition: transform 0.2s;
}
.file-card:hover, .folder-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>
{% endblock %}